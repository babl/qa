input {
  kafka {
    # zk_connect => "zookeeper:2181"
    zk_connect => "s1.babl.sh:2181"
    topic_id => "logs.raw"
    add_field => {
      "[@metadata][__input]" => "kafka"
      "[@metadata][__input__logs]" => "logs.raw"
    }
  }
}
filter {
  #----------------------
  # Check if message contains a non-empty RID property, evaluate if service is supervisor2/babl-server
  #----------------------
  if [@metadata][__input] == "kafka" and [@metadata][__input__logs] == "logs.raw" and [MESSAGE] =~ "\"rid\":.*" {

    #----------------------
    # evaluate service: supervisor2 / babl-server
    #----------------------
    if [CONTAINER_NAME] =~ "supervisor.*" {
      mutate {
        add_field => {
          "host" => "%{_HOSTNAME}"
          "service" => "supervisor2"
          "supervisor" => "supervisor2"
        }
      }
    } else {
      mutate {
        add_field => {
          "host" => "%{_HOSTNAME}"
          "service" => "babl-server"
          "module_raw" => "%{CONTAINER_NAME}"
          "module_version" => "v0"
        }
      }

      mutate {
        split => { "module_raw" => "." }
      }
      mutate {
        rename => [ "[module_raw][0]", "module" ]
        remove_field => "module_raw"
      }
      mutate {
        gsub => [ "module", "--", "/" ]
      }
    }
    #----------------------
    # end
    #----------------------
  }

  #----------------------
  # Supervisor2
  #----------------------
  if [service] == "supervisor2" {

    if [MESSAGE] =~ "^\{" {

      # parse message
      json {
        source => "MESSAGE"
        target => "data"
      }
      mutate {
        rename => {
          "[data][rid]" => "rid"
          "[data][key]" => "key"
          "[data][msg]" => "message"
          "[data][duration_ms]" => "duration_ms"
          "[data][error]" => "error"
          "[data][exitcode]" => "exitcode"
          "[data][level]" => "level"
          "[data][status]" => "status"
          "[data][stderr]" => "stderr"
          "[data][stdin]" => "stdin"
          "[data][stdout]" => "stdout"
          "[data][topics][0]" => "topic"
          "[data][topic]" => "topic"
          "[data][partition]" => "partition"
          "[data][offset]" => "offset"
          "[data][time]" => "timestamp"
        }
        convert => {
          "stdin" => "integer"
          "stdout" => "integer"
          "stderr" => "string"
          "exitcode" => "integer"
          "status" => "integer"
          "duration_ms" => "float"
        }
      }

      # pipes supervisor2 messages with "rid": into kafka.logs.qa
      if [MESSAGE] =~ "\"rid\":.*" and [rid] != "" {
        mutate {
          add_field => {
            "[@metadata][__output__logs]" => "logs.qa"
            "[@metadata][__debug]" => true
          }
        }
      }

      # remove data field
      mutate {
        remove_field => ["data"]
      }
    }
    #endif [message]
  }
  #endif [service] == "babl-server"

  #----------------------
  # Babl-Server
  #----------------------
  if [service] == "babl-server" {

    if [MESSAGE] =~ "^\{" {

      # parse message
      json {
        source => "MESSAGE"
        target => "data"
      }
      # INFO: do not rename: "[data][msg]" => "message (see the last block)"
      mutate {
        rename => {
          "[data][rid]" => "rid"
          "[data][key]" => "key"
          "[data][msg]" => "message"
          "[data][duration_ms]" => "duration_ms"
          "[data][error]" => "error"
          "[data][exitcode]" => "exitcode"
          "[data][level]" => "level"
          "[data][status]" => "status"
          "[data][stderr]" => "stderr"
          "[data][stdin]" => "stdin"
          "[data][stdout]" => "stdout"
          "[data][topics][0]" => "topic"
          "[data][topic]" => "topic"
          "[data][partition]" => "partition"
          "[data][offset]" => "offset"
          "[data][time]" => "timestamp"
        }
        convert => {
          "stdin" => "integer"
          "stdout" => "integer"
          "stderr" => "string"
          "exitcode" => "integer"
          "status" => "integer"
          "duration_ms" => "float"
        }
      }

      # pipes babl-server messages with "rid": into kafka.logs.qa
      if [MESSAGE] =~ "\"rid\":.*" and [rid] != "" {
        mutate {
          add_field => {
            "[@metadata][__output__logs]" => "logs.qa"
            "[@metadata][__debug]" => true
          }
        }
      }

      # remove data field
      mutate {
        remove_field => ["data"]
      }
    }
    #endif [message]
  }
  #endif [service] == "babl-server"
}
output {
  # For debugging
  # stdout { codec => rubydebug { metadata => true } }

  # NOTE: to debug use: mutate { add_field => { "[@metadata][__debug]" => true } }
  if [@metadata][__debug] {
    stdout { codec => rubydebug { metadata => true } }
  }

  if [@metadata][__output__logs] {
    kafka {
      # bootstrap_servers => "kafka:9092"
      bootstrap_servers => "s1.babl.sh:9092"
      topic_id => "%{[@metadata][__output__logs]}"
    }
  }
}